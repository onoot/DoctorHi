<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel - Doctor Height</title>
    <link rel='stylesheet' href='./wp-content/plugins/elementor/assets/lib/font-awesome/css/all.mind1c0.css'
        media='all' />

    <style>
        /* Стили для статусов */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            display: inline-block;
        }

        .status-badge.active {
            background-color: #e6f7ee;
            color: #1a7f37;
        }

        .status-badge.blocked {
            background-color: #fff1f0;
            color: #d92d20;
        }

        .status-badge.archived {
            background-color: #f5f5f5;
            color: #5e6675;
        }

        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-color: #f8f9fa;
            --border-color: #dee2e6;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Боковое меню */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px 0;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 1.5em;
            color: var(--primary-color);
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .nav-item {
            padding: 0;
            margin: 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--secondary-color);
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: var(--background-color);
            color: var(--primary-color);
        }

        /* Основной контент */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Общие стили для секций */
        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }

        /* Поиск */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        .search-btn {
            padding: 8px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .search-btn:hover {
            background: #0056b3;
        }

        /* Таблицы */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--background-color);
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        /* Кнопки действий */
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 2px;
            color: white;
        }

        .btn-view {
            background-color: #007bff;
        }

        .btn-view:hover {
            background-color: #0056b3;
        }

        .file-upload-container {
            display: inline-block;
            position: relative;
        }

        .hidden-file-input {
            display: none;
        }

        .btn-file {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            margin-top: 16px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-file:hover {
            background-color: #218838;
        }

        .btn-file:active {
            background-color: #1e7e34;
        }

        .btn-edit {
            background-color: #28a745;
        }

        .btn-edit:hover {
            background-color: #218838;
        }

        .btn-delete {
            background-color: #dc3545;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .btn-download {
            background-color: #17a2b8;
        }

        .btn-download:hover {
            background-color: #138496;
        }

        /* Выпадающие списки для объектов */
        .property-category {
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .category-header {
            padding: 12px 15px;
            background-color: var(--background-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .category-header h3 {
            margin: 0;
            font-size: 1.1em;
            color: #333;
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .property-category.active .category-content {
            max-height: 1000px;
        }

        .category-header i.fa-chevron-down {
            transition: transform 0.3s;
        }

        .property-category.active .category-header i.fa-chevron-down {
            transform: rotate(180deg);
        }

        /* Стили для статусов */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-badge.pending {
            background-color: #ffd700;
            color: #000;
        }

        .status-badge.approved {
            background-color: var(--success-color);
            color: white;
        }

        .status-badge.rejected {
            background-color: var(--danger-color);
            color: white;
        }

        .status-badge.cancelled {
            background-color: var(--secondary-color);
            color: white;
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 5s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);

            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        /* Пагинация */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--background-color);
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            color: var(--secondary-color);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Загрузка */
        .loading {
            position: relative;
            min-height: 200px;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            margin: -20px 0 0 -20px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Стили для формы */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .form-group input[readonly] {
            background-color: var(--background-color);
        }

        .form-group button {
            margin-top: 5px;
        }

        /* Стили для формы транзакций */
        #addTransactionModal .modal-content {
            max-width: 600px;
            width: 100%;
        }

        #addTransactionModal .form-group {
            margin-bottom: 20px;
        }

        #addTransactionModal label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        #addTransactionModal select,
        #addTransactionModal input[type="number"],
        #addTransactionModal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        #addTransactionModal select:focus,
        #addTransactionModal input[type="number"]:focus,
        #addTransactionModal textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        #addTransactionModal select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        #addTransactionModal textarea {
            resize: vertical;
            min-height: 80px;
        }

        #addTransactionModal .modal-footer {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            #addTransactionModal .modal-content {
                max-width: 100%;
                margin: 10px;
            }

            #addTransactionModal .modal-footer {
                flex-direction: column;
            }

            #addTransactionModal .modal-footer button {
                width: 100%;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .transaction-details {
            margin-bottom: 30px;
        }

        .files-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .file-category {
            background-color: #1b1e20;
            padding: 15px;
            border-radius: 8px;
            color: white;

            & button {
                color: black;
            }
        }

        .file-item {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            padding: 1rem;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            border-radius: 4px;
            background: white;
            gap: 1rem;

            & img {
                max-width: 200px;
                max-height: 200px;
                object-fit: cover;
            }
        }

        .file-preview {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
            text-align: center;
        }

        .file-preview img {
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
            border-radius: 4px;
        }

        .file-preview i {
            font-size: 48px;
            color: #666;
        }

        .file-icon {
            font-size: 3rem;
            color: var(--secondary-color);
        }

        .file-info {
            flex: 1;
            min-width: 200px;
        }

        .file-name {
            font-weight: bold;
            margin: 0 0 0.5rem 0;
            word-break: break-all;
        }

        .file-type,
        .file-date {
            color: var(--secondary-color);
            margin: 0 0 0.25rem 0;
            font-size: 0.9rem;
        }

        .file-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 120px;
        }

        .file-actions button {
            width: 100%;
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }

        .file-actions button:hover {
            opacity: 0.9;
        }

        .file-actions button:not(.delete-btn) {
            background-color: var(--primary-color);
            color: white;
        }

        .delete-btn {
            background-color: var(--danger-color);
            color: white;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .file-item {
                flex-direction: column;
            }

            .file-preview,
            .file-icon {
                align-self: center;
            }

            .file-info {
                width: 100%;
                text-align: center;
            }

            .file-actions {
                width: 100%;
            }
        }

        /* Базовые стили для контейнера уведомлений */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        /* Стили для отдельного уведомления */
        .notification {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            max-width: 300px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            /* Начальное состояние: невидимо */
            transform: translateY(-20px);
            /* Начальное положение: выше видимой области */
            transition: all 0.3s ease;
            /* Плавный переход */
        }

        /* Активное состояние уведомления */
        .notification.show {
            opacity: 1;
            /* Полностью видимо */
            transform: translateY(0);
            /* Видимое положение */
        }

        /* Цветовые стили */
        .notification.success {
            background-color: var(--success-color, #28a745);
            /* Зеленый цвет */
        }

        .notification.error {
            background-color: var(--danger-color, #dc3545);
            /* Красный цвет */
        }

        /* Добавляем стили для платежей */
        .payments-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .payment-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .payment-info {
            text-align: center;
        }

        .payment-info h3 {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .payment-info p {
            margin: 0.5rem 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .payment-list {
            margin-top: 1rem;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .payment-item .payment-details {
            flex: 1;
        }

        .payment-item .payment-actions {
            display: flex;
            gap: 0.5rem;
        }

        .payment-form {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .payment-form form {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: #666;
        }

        .form-group input,
        .form-group select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-group input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        /* Стили для формы свидетелей */
        .witness-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .witness-group h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9em;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .form-control:invalid {
            border-color: #dc3545;
        }

        .form-control::placeholder {
            color: #adb5bd;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            margin: 0 0 20px 0;
            color: #007bff;
            font-size: 1.2em;
        }

        /* Стили для раздела transfer requests */
        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-badge.approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-badge.rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .btn-approve {
            background-color: #28a745;
            color: white;
        }

        .btn-reject {
            background-color: #dc3545;
            color: white;
        }

        .btn-view {
            background-color: #17a2b8;
            color: white;
        }

        .filters {
            margin-bottom: 20px;
        }

        .filters select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* Стили для секции запросов на сделку */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-badge.pending {
            background-color: #ffd700;
            color: #000;
        }

        .status-badge.approved {
            background-color: #4CAF50;
            color: white;
        }

        .status-badge.rejected {
            background-color: #f44336;
            color: white;
        }

        #transferRequestsSection .filter-section {
            margin-bottom: 20px;
        }

        #transferRequestsSection select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* Styles for request section */
        .filter-controls {
            margin-bottom: 20px;
        }

        .filter-controls select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 150px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.pending {
            background-color: #ffd700;
            color: #000;
        }

        .status-badge.approved {
            background-color: #4CAF50;
            color: white;
        }

        .status-badge.rejected {
            background-color: #f44336;
            color: white;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-approve {
            background-color: #4CAF50;
            color: white;
        }

        .btn-reject {
            background-color: #f44336;
            color: white;
        }

        .action-text {
            font-size: 12px;
            color: #666;
        }

        .fa-info-circle {
            color: #2196F3;
            cursor: help;
        }

        /* Добавляем стили для секции свидетелей */
        .witnesses-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .witnesses-section h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.2em;
        }

        .witness-block {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .witness-block h4 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dce4ec;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .witness-actions {
            margin-top: 20px;
            text-align: right;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-approve {
            background-color: #2ecc71;
            color: white;
        }

        .btn-approve:hover {
            background-color: #27ae60;
        }

        /* Стили для сообщений об ошибках */
        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .form-control.error {
            border-color: #e74c3c;
        }

        .form-control.error+.error-message {
            display: block;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Боковое меню -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Admin Panel</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="#transactions" class="nav-link active" data-section="transactions"><i
                            class="fas fa-exchange-alt"></i> Transactions</a></li>
                <li class="nav-item"><a href="#users" class="nav-link" data-section="users">
                        <i class="fas fa-users"></i>
                        Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#users-archive">
                        <i class="fas fa-users"></i> Users (Archive)
                    </a>
                </li>
            </ul>
        </div>
        <!-- Секция сделок -->
        <div id="transactions" class="section active">
            <div class="section-header">
                <h2 class="section-title">All Transactions</h2>
                <button class="action-btn btn-edit" id="create">
                    <i class="fas fa-plus"></i>
                    New Transaction
                </button>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search transactions...">
                <button class="search-btn">
                    <i class="fas fa-search"></i>
                    Search
                </button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Property</th>
                        <th>Previous Owner</th>
                        <th>New Owner</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactionsTableBody">
                    <!-- Данные будут добавлены через JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Секция пользователей -->
        <div id="users" class="section">
            <div class="section-header">
                <h2 class="section-title">All Users</h2>
                <button class="action-btn btn-edit" id="openAddUserModal">
                    <i class="fas fa-user-plus"></i> Add User
                </button>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search users...">
                <button class="search-btn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>CNIC</th>
                            <th>Email</th>
                            <th>Properties</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Данные будут добавлены через JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Основной контент -->
        <div class="main-content">
            <!-- Модальное окно для просмотра пользователя -->
            <div id="userModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">User Details</h3>
                        <button class="modal-close" data-modal="userModal">&times;</button>
                    </div>
                    <div class="modal-body" id="userModalBody">
                        <!-- Данные будут добавлены через JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Модальное окно для просмотра сделки -->
            <div id="viewTransactionModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Transaction Details</h2>
                        <span class="close" data-modal="viewTransactionModal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="currentTransactionId">
                        <div class="transaction-details">
                            <p><strong>Transaction ID:</strong> <span id="transactionId"></span></p>
                            <p><strong>Property:</strong> <span id="propertyName"></span></p>
                            <p><strong>Previous Owner:</strong> <span id="previousOwner"></span></p>
                            <p><strong>New Owner:</strong> <span id="newOwner"></span></p>
                            <p><strong>Status:</strong> <span id="transactionStatus"></span></p>
                            <!-- Контейнеры для документов -->
                            <div class="transaction-documents">
                                <h3>Agreement File:</h3>
                                <div id="agreementFile"></div>
                                <h3>Video File:</h3>
                                <div id="videoFile"></div>

                                <h3>Proof Documents:</h3>
                                <div id="proofDocuments"></div>
                            </div>

                            <!-- Таблица платежей -->
                            <table id="paymentsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>Receipt</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody"></tbody>
                            </table>
                            <div class="amount-section">
                                <p><strong>Total Amount:</strong>
                                    <span id="totalAmount"></span>
                                    <button class="action-btn btn-edit edit-amount-btn"
                                        style="padding: 2px 8px; margin-left: 10px;">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </p>
                                <div id="amountEditSection" style="display: none; margin: 10px 0;">
                                    <input type="number" id="newTotalAmount" class="form-control"
                                        placeholder="Enter new amount" style="width: 200px; display: inline-block;">
                                    <button class="action-btn btn-approve save-amount-btn" style="margin-left: 10px;">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                    <button class="action-btn btn-reject cancel-amount-btn" style="margin-left: 5px;">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                            <p><strong>Paid Amount:</strong> <span id="paidAmount"></span></p>
                            <p><strong>Remaining Amount:</strong> <span id="remainingAmount"></span></p>
                            <p><strong>Created Date:</strong> <span id="createdAt"></span></p>
                        </div>

                        <div class="witnesses-section">
                            <h3>Witnesses Information</h3>
                            <div class="witness-form">
                                <div class="witness-block">
                                    <h4>Witness 1</h4>
                                    <div class="form-group">
                                        <label>Name *</label>
                                        <input type="text" id="witness1Name" class="form-control"
                                            placeholder="Enter witness name">
                                    </div>
                                    <div class="form-group">
                                        <label>CNIC *</label>
                                        <input type="text" id="witness1CNIC" class="form-control"
                                            placeholder="XXXXX-XXXXXXX-X">
                                    </div>
                                    <div class="form-group">
                                        <label>Phone</label>
                                        <input type="text" id="witness1Phone" class="form-control"
                                            placeholder="+XXXXXXXXXXXX">
                                    </div>
                                </div>

                                <div class="witness-block">
                                    <h4>Witness 2</h4>
                                    <div class="form-group">
                                        <label>Name *</label>
                                        <input type="text" id="witness2Name" class="form-control"
                                            placeholder="Enter witness name">
                                    </div>
                                    <div class="form-group">
                                        <label>CNIC *</label>
                                        <input type="text" id="witness2CNIC" class="form-control"
                                            placeholder="XXXXX-XXXXXXX-X">
                                    </div>
                                    <div class="form-group">
                                        <label>Phone</label>
                                        <input type="text" id="witness2Phone" class="form-control"
                                            placeholder="+XXXXXXXXXXXX">
                                    </div>
                                </div>

                                <div class="witness-actions">
                                    <button class="action-btn btn-approve update-witnesses-btn">
                                        <i class="fas fa-save"></i> Save Witnesses
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Модальное окно для добавления пользователя -->
            <div id="addUserModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Add New User</h3>
                        <button class="modal-close" data-modal="addUserModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="addUserForm">
                            <div class="form-group">
                                <label for="userName">Full Name*</label>
                                <input type="text" id="userName" required>
                            </div>
                            <div class="form-group">
                                <label for="userCnic">CNIC*</label>
                                <input type="text" id="userCnic" required placeholder="12345-1234567-1">
                            </div>
                            <div class="form-group">
                                <label for="userPhone">Phone Number*</label>
                                <input type="tel" id="userPhone" required placeholder="+923001234567">
                            </div>
                            <div class="form-group">
                                <label for="userAddress">Address*</label>
                                <textarea id="userAddress" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="userLogin">Login (generated)</label>
                                <input type="text" id="userLogin">
                                <button type="button" class="action-btn btn-edit regenerate-login-btn">
                                    <i class="fas fa-sync"></i> Regenerate
                                </button>
                            </div>
                            <div class="form-group">
                                <label for="userPassword">Password (generated)</label>
                                <input type="text" id="userPassword">
                                <button type="button" class="action-btn btn-edit regenerate-password-btn">
                                    <i class="fas fa-sync"></i> Regenerate
                                </button>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="action-btn btn-delete cancel-user-btn">Cancel</button>
                                <button type="submit" class="action-btn btn-edit create-user-btn">Create User</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Модальное окно для создания транзакции -->
            <div id="createTransactionModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Create Transaction</h3>
                        <span class="close" data-modal="createTransactionModal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="createTransactionForm">
                            <div class="form-group">
                                <label for="propertyId">Property</label>
                                <select id="propertyId" class="form-control" name="property_id" required>
                                    <!-- Property options will be populated via JavaScript -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newOwnerId">New Owner</label>
                                <select id="newOwnerId" class="form-control" name="new_owner_id" required>
                                    <!-- User options will be populated via JavaScript -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="totalAmount">Total Amount (PKR)</label>
                                <input type="number" id="totalAmount" name="total_amount" class="form-control" required
                                    min="0" step="0.01" placeholder="0.00">
                            </div>

                            <!-- Witnesses Information -->
                            <div class="form-section">
                                <h3>Witnesses Information</h3>

                                <!-- Witness 1 -->
                                <div class="witness-group">
                                    <h4>Witness 1</h4>
                                    <div class="form-group">
                                        <label for="witness1Name">Name</label>
                                        <input type="text" id="witness1Name" name="witness1Name" class="form-control"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="witness1CNIC">CNIC</label>
                                        <input type="text" id="witness1CNIC" name="witness1CNIC" class="form-control"
                                            placeholder="12345-1234567-1" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="witness1Phone">Phone</label>
                                        <input type="tel" id="witness1Phone" name="witness1Phone" class="form-control"
                                            pattern="[+]\d{1,3}-\d{10}" placeholder="+92-1234567890">
                                    </div>
                                </div>

                                <!-- Witness 2 -->
                                <div class="witness-group">
                                    <h4>Witness 2</h4>
                                    <div class="form-group">
                                        <label for="witness2Name">Name</label>
                                        <input type="text" id="witness2Name" name="witness2Name" class="form-control"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="witness2CNIC">CNIC</label>
                                        <input type="text" id="witness2CNIC" name="witness2CNIC" class="form-control"
                                            placeholder="12345-1234567-1" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="witness2Phone">Phone</label>
                                        <input type="tel" id="witness2Phone" name="witness2Phone" class="form-control"
                                            pattern="[+]\d{1,3}-\d{10}" placeholder="+92-1234567890">
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button"
                                    class="action-btn btn-delete cancel-transaction-btn">Cancel</button>
                                <button type="submit" class="action-btn btn-edit create-transaction-btn">Create
                                    Transaction</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Модальное окно для загрузки одного файла -->
            <div id="uploadFileModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Upload File</h2>
                        <span class="close" data-modal="uploadFileModal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="singleFileUploadForm">
                            <input type="hidden" id="uploadTransactionId" name="transactionId">
                            <input type="hidden" id="uploadCategory" name="category">
                            <div class="form-group">
                                <label for="file">Select File</label>
                                <input type="file" id="file" name="agreement"
                                    accept="image/jpeg,image/png,application/pdf" required class="file-input">
                                <div id="imagePreview" style="margin-top: 10px; max-width: 300px;">
                                    <img id="previewImage" style="max-width: 100%; display: none;">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="action-btn btn-delete cancel-upload-btn">Cancel</button>
                                <button type="submit" class="action-btn btn-edit upload-single-btn">Upload</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Модальное окно для множественной загрузки файлов -->
            <div id="multipleUploadModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Upload Documents</h2>
                        <span class="close" data-modal="multipleUploadModal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="multipleFileUploadForm">
                            <input type="hidden" id="multiUploadTransactionId" name="transactionId">
                            <div class="form-group">
                                <label for="files">Select Files</label>
                                <input type="file" id="files" name="proof_documents" multiple
                                    accept="image/jpeg,image/png,application/pdf" required>
                            </div>
                            <div class="modal-footer">
                                <button type="button"
                                    class="action-btn btn-delete cancel-multi-upload-btn">Cancel</button>
                                <button type="submit" class="action-btn btn-edit upload-multiple-btn">Upload</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Форма транзакции -->
            <div class="transaction-form section" id="transactionForm">
                <div class="section-header">
                    <h2 class="section-title">Transaction Details</h2>
                </div>
                <form id="newTransactionForm">
                    <!-- Witnesses Information -->
                    <div class="form-section">
                        <h3>Witnesses Information</h3>

                        <!-- Witness 1 -->
                        <div class="witness-group">
                            <h4>Witness 1</h4>
                            <div class="form-group">
                                <label for="witness1Name">Name</label>
                                <input type="text" id="witness1Name" name="witness1Name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="witness1CNIC">CNIC</label>
                                <input type="text" id="witness1CNIC" name="witness1CNIC" class="form-control"
                                    placeholder="12345-1234567-1" required>
                            </div>
                            <div class="form-group">
                                <label for="witness1Phone">Phone</label>
                                <input type="tel" id="witness1Phone" name="witness1Phone" class="form-control"
                                    pattern="[+]\d{1,3}-\d{10}" placeholder="+92-1234567890">
                            </div>
                        </div>

                        <!-- Witness 2 -->
                        <div class="witness-group">
                            <h4>Witness 2</h4>
                            <div class="form-group">
                                <label for="witness2Name">Name</label>
                                <input type="text" id="witness2Name" name="witness2Name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="witness2CNIC">CNIC</label>
                                <input type="text" id="witness2CNIC" name="witness2CNIC" class="form-control"
                                    placeholder="12345-1234567-1" required>
                            </div>
                            <div class="form-group">
                                <label for="witness2Phone">Phone</label>
                                <input type="tel" id="witness2Phone" name="witness2Phone" class="form-control"
                                    pattern="[+]\d{1,3}-\d{10}" placeholder="+92-1234567890">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="action-btn btn-edit">Create Transaction</button>
                </form>
            </div>

            <script>

                let exchangeRateCache = null;
                let lastFetchTime = 0;
                const CACHE_DURATION = 5 * 60 * 1000; // 5 минут

                // Форматирование суммы в долларах
                function formatUSD(amount) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 2
                    }).format(amount);
                }

                // Получение курса обмена PKR к USD
                async function getExchangeRatePKRtoUSD() {
                    try {

                        // Если внутренний API недоступен, используем внешний
                        const externalResponse = await fetch('https://api.exchangerate-api.com/v4/latest/PKR');
                        const data = await externalResponse.json();
                        return data.rates.USD;
                    } catch (error) {
                        console.error('Error fetching exchange rate:', error);
                        showNotification('error', 'Could not get current exchange rate. Using approximate value.');
                        // Приблизительный курс (актуален на момент написания)
                        return 0.0036;
                    }
                }
                async function getCachedExchangeRate() {
                    const now = Date.now();
                    if (exchangeRateCache && (now - lastFetchTime) < CACHE_DURATION) {
                        return exchangeRateCache;
                    }

                    exchangeRateCache = await getExchangeRatePKRtoUSD();
                    lastFetchTime = now;
                    return exchangeRateCache;
                }


                function openCreateTransactionModal() {
                    loadProperties();
                    openModal('createTransactionModal');

                    // Небольшая задержка для гарантированной загрузки модального окна
                    setTimeout(() => {
                        const totalAmountInput = document.getElementById('totalAmount');
                        if (totalAmountInput) {
                            // Создаем элемент для отображения конвертации, если его нет
                            let conversionElement = totalAmountInput.parentNode.querySelector('.currency-conversion');
                            if (!conversionElement) {
                                conversionElement = document.createElement('div');
                                conversionElement.className = 'currency-conversion';
                                conversionElement.style.marginTop = '5px';
                                conversionElement.style.color = '#666';
                                conversionElement.style.fontSize = '0.9em';
                                totalAmountInput.parentNode.appendChild(conversionElement);
                            }

                            // Добавляем обработчик для пересчета суммы
                            totalAmountInput.addEventListener('input', async function () {
                                const pkrAmount = parseFloat(this.value) || 0;
                                const exchangeRate = await getExchangeRatePKRtoUSD();
                                const usdAmount = pkrAmount * exchangeRate;

                                conversionElement.innerHTML = `
          <span>≈ ${formatUSD(usdAmount)} USD</span>
          <span style="font-size: 0.8em; display: block; margin-top: 3px; opacity: 0.7">
            (1 PKR = ${exchangeRate.toFixed(6)} USD)
          </span>
        `;
                            });

                            // Имитируем событие для первоначального расчета
                            const event = new Event('input', { bubbles: true });
                            totalAmountInput.dispatchEvent(event);
                        }
                    }, 100);
                }
                // Затем используйте getCachedExchangeRate() вместо getExchangeRatePKRtoUSD() в обработчике



                const API_BASE_URL = `https://${window?.location?.host}/api`;
                let currentPage = 1;
                let itemsPerPage = 10;

                // Предопределенный массив объектов недвижимости
                const properties = {
                    'Parking': [
                        { id: 'DH01', name: 'Parking DH01', type: 'parking' },
                        { id: 'DH02', name: 'Parking DH02', type: 'parking' },
                        { id: 'DH03', name: 'Parking DH03', type: 'parking' }
                    ], "Lower Basement": [
                        { "id": "LB01", "name": "Parking LB01", "type": "parking" },
                        { "id": "LB02", "name": "Parking LB02", "type": "parking" },
                        { "id": "LB03", "name": "Parking LB03", "type": "parking" },
                        { "id": "LB04", "name": "Parking LB04", "type": "parking" },
                        { "id": "LB05", "name": "Parking LB05", "type": "parking" },
                        { "id": "LB06", "name": "Parking LB06", "type": "parking" },
                        { "id": "LB07", "name": "Parking LB07", "type": "parking" },
                        { "id": "LB08", "name": "Parking LB08", "type": "parking" },
                        { "id": "LB09", "name": "Parking LB09", "type": "parking" },
                        { "id": "LB10", "name": "Parking LB10", "type": "parking" },
                        { "id": "LB11", "name": "Parking LB11", "type": "parking" },
                        { "id": "LB12", "name": "Parking LB12", "type": "parking" }
                    ],
                    "Upper Basement": [
                        { "id": "UB01", "name": "Parking UB01", "type": "parking" },
                        { "id": "UB02", "name": "Parking UB02", "type": "parking" },
                        { "id": "UB03", "name": "Parking UB03", "type": "parking" },
                        { "id": "UB04", "name": "Parking UB04", "type": "parking" },
                        { "id": "UB05", "name": "Parking UB05", "type": "parking" },
                        { "id": "UB06", "name": "Parking UB06", "type": "parking" },
                        { "id": "UB07", "name": "Parking UB07", "type": "parking" },
                        { "id": "UB08", "name": "Parking UB08", "type": "parking" },
                        { "id": "UB09", "name": "Parking UB09", "type": "parking" },
                        { "id": "UB10", "name": "Parking UB10", "type": "parking" },
                        { "id": "UB11", "name": "Parking UB11", "type": "parking" },
                        { "id": "UB12", "name": "Parking UB12", "type": "parking" }
                    ],
                    'Ground Floor': [
                        { id: 'DH01', name: 'Shop DH01', type: 'commercial' },
                        { id: 'DH02', name: 'Shop DH02', type: 'commercial' },
                        { id: 'DH03', name: 'Shop DH03', type: 'commercial' }
                    ],
                    '1st Floor': [
                        { id: 'DH101', name: 'Office DH101', type: 'commercial' },
                        { id: 'DH102', name: 'Office DH102', type: 'commercial' },
                        { id: 'DH103', name: 'Office DH103', type: 'commercial' }
                    ],
                    '2nd Floor': [
                        { id: 'DH201', name: 'Office DH201', type: 'commercial' },
                        { id: 'DH202', name: 'Office DH202', type: 'commercial' },
                        { id: 'DH203', name: 'Office DH203', type: 'commercial' }
                    ],
                    '3rd Floor': [
                        { id: 'DH301', name: 'Apartment DH301 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH302', name: 'Apartment DH302 (973.7 Sft)', type: 'residential' },
                        { id: 'DH303', name: 'Apartment DH303 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH304', name: 'Apartment DH304 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH305', name: 'Apartment DH305 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH306', name: 'Apartment DH306 (1,686.00 Sft)', type: 'residential' }
                    ],
                    '4th Floor': [
                        { id: 'DH401', name: 'Apartment DH401 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH402', name: 'Apartment DH402 (973.7 Sft)', type: 'residential' },
                        { id: 'DH403', name: 'Apartment DH403 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH404', name: 'Apartment DH404 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH405', name: 'Apartment DH405 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH406', name: 'Apartment DH406 (1,686.00 Sft)', type: 'residential' }
                    ],
                    '5th Floor': [
                        { id: 'DH501', name: 'Apartment DH501 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH502', name: 'Apartment DH502 (973.7 Sft)', type: 'residential' },
                        { id: 'DH503', name: 'Apartment DH503 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH504', name: 'Apartment DH504 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH505', name: 'Apartment DH505 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH506', name: 'Apartment DH506 (1,686.00 Sft)', type: 'residential' }
                    ],
                    '6th Floor': [
                        { id: 'DH601', name: 'Apartment DH601 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH602', name: 'Apartment DH602 (973.7 Sft)', type: 'residential' },
                        { id: 'DH603', name: 'Apartment DH603 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH604', name: 'Apartment DH604 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH605', name: 'Apartment DH605 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH606', name: 'Apartment DH606 (1,686.00 Sft)', type: 'residential' }
                    ],
                    '7th Floor': [
                        { id: 'DH701', name: 'Apartment DH701 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH702', name: 'Apartment DH702 (973.7 Sft)', type: 'residential' },
                        { id: 'DH703', name: 'Apartment DH703 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH704', name: 'Apartment DH704 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH705', name: 'Apartment DH705 (1,198.3 Sft)', type: 'residential' },
                        { id: 'DH706', name: 'Apartment DH706 (1,686.00 Sft)', type: 'residential' }
                    ],
                    'Penthouse': [
                        { id: 'PH', name: 'Penthouse (7,350.00 Sft)', type: 'penthouse' }
                    ]
                };
                // Проверка авторизации при загрузке страницы
                document.addEventListener('DOMContentLoaded', async function () {
                    try {
                        const response = await fetch(`${API_BASE_URL}/auth/admin/validate`, {
                            method: 'GET',
                            credentials: 'include',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Not authenticated');
                        }

                        const userData = await response.json();
                        const currentUser = userData.user;

                        // Настройка обработчиков для навигации
                        document.querySelectorAll('.nav-link').forEach(link => {
                            link.addEventListener('click', function (e) {
                                e.preventDefault();
                                const sectionId = this.getAttribute('href').substring(1);
                                showSection(sectionId);
                            });
                        });

                        // Настраиваем поиск
                        setupSearch();

                        // Проверяем, существует ли элемент с id="users-archive"
                        if (!document.getElementById('users-archive')) {
                            // Создаем элемент для архивных пользователей, если его нет
                            const usersArchiveSection = document.createElement('div');
                            usersArchiveSection.id = 'users-archive';
                            usersArchiveSection.className = 'section';
                            usersArchiveSection.style.display = 'none';
                            usersArchiveSection.innerHTML = `
        <div class="section-header">
          <h2 class="section-title">Archived Users</h2>
        </div>
        <div class="search-box">
          <input type="text" class="search-input" placeholder="Search archived users...">
          <button class="search-btn">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>CNIC</th>
              <th>Email</th>
              <th>Properties</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      `;
                            document.querySelector('.main-content').appendChild(usersArchiveSection);
                        }

                        // Определяем, какой раздел показать по умолчанию
                        const urlParams = new URLSearchParams(window.location.search);
                        const initialSection = urlParams.get('section') || 'transactions';

                        // Проверяем, существует ли элемент с таким id
                        if (document.getElementById(initialSection)) {
                            showSection(initialSection);
                        } else {
                            console.error(`Initial section "${initialSection}" not found, defaulting to transactions`);
                            showSection('transactions');
                        }

                        // Добавляем обработчик для поиска
                        document.querySelector('#users .search-input')?.addEventListener('input', debounce(function () {
                            currentPage = 1;
                            const activeSection = document.querySelector('.section.active')?.id;
                            if (activeSection === 'users') {
                                loadUsers('active');
                            } else if (activeSection === 'users-archive') {
                                loadUsers('archived');
                            }
                        }, 300));

                    } catch (error) {
                        console.error('Authentication error:', error);
                        window.location.href = '/login.html';
                    }
                });
                // Функция выхода
                async function logout() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/auth/logout`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Logout failed');
                        }
                    } catch (error) {
                        console.error('Logout error:', error);
                    } finally {
                        window.location.href = '/login.html';
                    }
                }

                // Функция для выполнения API запросов
                async function apiRequest(endpoint, options = {}) {
                    console.log('Making API request to:', endpoint);
                    const defaultOptions = {
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'include'
                    };

                    try {
                        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                            ...defaultOptions,
                            ...options,
                            headers: {
                                ...defaultOptions.headers,
                                ...(options.headers || {})
                            },
                            credentials: 'include',
                        });

                        console.log('API response status:', response.status);

                        // Пытаемся распарсить ответ как JSON
                        let data = null;
                        try {
                            data = await response.json();
                        } catch (e) {
                            // Если не удалось распарсить JSON, используем текстовый ответ
                            const text = await response.text();
                            console.log('API response text:', text);
                            data = { message: text || 'Unknown error' };
                        }

                        console.log('API response data:', data);

                        if (!response.ok) {
                            console.log('API request failed:', data);
                            throw new Error(data.message || 'API request failed');
                        }

                        return data;
                    } catch (error) {
                        console.error('API request failed:', error);
                        throw error;
                    }
                }
                // Функции для уведомлений
                function showNotification(type, message) {
                    let duration = 3000
                    // Создаем контейнер для уведомлений, если его еще нет
                    let container = document.getElementById('notification-container');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'notification-container';
                        document.body.appendChild(container);
                    }

                    // Создаем элемент уведомления
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.textContent = message;

                    // Добавляем уведомление в контейнер
                    container.appendChild(notification);

                    // Показываем уведомление с анимацией
                    setTimeout(() => {
                        notification.classList.add('show');
                    }, 10); // Небольшая задержка для корректного запуска анимации

                    // Автоматически скрываем и удаляем уведомление через указанное время
                    setTimeout(() => {
                        notification.classList.remove('show'); // Запускаем анимацию исчезновения
                        setTimeout(() => {
                            notification.remove(); // Удаляем элемент из DOM
                        }, 300); // Ждем завершения анимации исчезновения
                    }, duration);
                }
                // Функции для пагинации
                function createPagination(totalItems, currentPage, itemsPerPage) {
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    const pagination = document.createElement('div');
                    pagination.className = 'pagination';

                    // Кнопка "Предыдущая"
                    const prevButton = document.createElement('button');
                    prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    prevButton.disabled = currentPage === 1;
                    prevButton.onclick = () => {
                        if (currentPage > 1) {
                            currentPage--;
                            loadCurrentSection();
                        }
                    };
                    pagination.appendChild(prevButton);

                    // Текущая страница
                    const pageInfo = document.createElement('span');
                    pageInfo.className = 'current-page';
                    pageInfo.textContent = `${currentPage} / ${totalPages}`;
                    pagination.appendChild(pageInfo);

                    // Кнопка "Следующая"
                    const nextButton = document.createElement('button');
                    nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    nextButton.disabled = currentPage === totalPages;
                    nextButton.onclick = () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            loadCurrentSection();
                        }
                    };
                    pagination.appendChild(nextButton);

                    return pagination;
                }

                // Функция загрузки текущего раздела
                function loadCurrentSection() {
                    const activeSection = document.querySelector('.section.active');
                    if (!activeSection) return;

                    switch (activeSection.id) {
                        case 'transactions':
                            loadTransactions();
                            break;
                        case 'users':
                            loadUsers('active');
                            break;
                        case 'users-archive':
                            loadUsers('archived');
                            break;
                    }
                }

                async function loadTransactions() {
                    const section = document.getElementById('transactions');
                    section.classList.add('loading');

                    const searchInput = section.querySelector('.search-input');
                    const searchParams = new URLSearchParams({
                        page: currentPage,
                        limit: itemsPerPage
                    });

                    if (searchInput?.value) {
                        searchParams.append('search', searchInput.value);
                    }

                    const data = await apiRequest(`/v1/admin/transactions?${searchParams}`);
                    section.classList.remove('loading');

                    if (!data) return;

                    const tbody = document.getElementById('transactionsTableBody');
                    tbody.innerHTML = data.transactions.map(t => `
        <tr>
            <td>${t.id}</td>
            <td>${t.property_id}</td>
            <td>${t.previous_owner_id || 'No'}</td>
            <td>${t.new_owner_id}</td>
            <td>${new Date(t.created_at).toLocaleDateString()}</td>
            <td><span class="status-badge ${t.status.toLowerCase()}">${t.status}</span></td>
            <td>
                <button class="action-btn btn-view" data-id="${t.id}" data-action="view">
                    <i class="fas fa-eye"></i> View
                </button>
                ${t.status === 'pending' ? `
                    <button class="action-btn btn-edit" data-id="${t.id}" data-action="approve">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="action-btn btn-delete" data-id="${t.id}" data-action="reject">
                        <i class="fas fa-times"></i> Reject
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');

                    // Добавляем пагинацию
                    const existingPagination = section.querySelector('.pagination');
                    if (existingPagination) {
                        existingPagination.remove();
                    }
                    section.appendChild(createPagination(data.total, currentPage, itemsPerPage));

                    // Привязываем обработчики событий к динамическим кнопкам
                    attachActionHandlers3();
                }
                function renderUsersTable(users) {
                    const tbody = document.getElementById('usersTableBody');
                    if (!tbody) {
                        console.error('Users table body not found');
                        return;
                    }

                    // Проверяем, что users - это массив
                    if (!Array.isArray(users)) {
                        console.error('Expected users to be an array, but got:', users);
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Invalid data format</td></tr>';
                        return;
                    }

                    tbody.innerHTML = '';

                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
                        return;
                    }

                    users.forEach(user => {
                        const row = document.createElement('tr');

                        // Убедимся, что у пользователя есть статус
                        const userStatus = user.status || 'active';

                        // Используем безопасный доступ к свойствам и предоставляем fallback значения
                        row.innerHTML = `
      <td>${user.id || ''}</td>
      <td>${user.name || ''}</td>
      <td>${user.cnic || ''}</td>
      <td>${user.email || user.login || ''}</td>
      <td>${user.properties_count !== undefined ? user.properties_count : 0}</td>
      <td><span class="status-badge ${userStatus}">${userStatus}</span></td>
      <td class="actions-cell"></td>
    `;

                        const actionsCell = row.querySelector('.actions-cell');

                        // Для архивных пользователей показываем только кнопку восстановления
                        if (userStatus === 'archived') {
                            actionsCell.innerHTML = `
        <button class="action-btn btn-edit" data-id="${user.id}" data-action="restore">
          <i class="fas fa-undo"></i> Restore
        </button>
      `;
                        } else {
                            // Для активных пользователей показываем все кнопки действий
                            actionsCell.innerHTML = `
        <button class="action-btn btn-view" data-id="${user.id}" data-action="view">
          <i class="fas fa-eye"></i> View
        </button>
        <button class="action-btn btn-edit" data-id="${user.id}" data-status="${userStatus === 'active' ? 'blocked' : 'active'}" data-action="toggle-status">
          <i class="fas ${userStatus === 'active' ? 'fa-ban' : 'fa-check'}"></i> ${userStatus === 'active' ? 'Block' : 'Activate'}
        </button>
        <button class="action-btn btn-delete" data-id="${user.id}" data-action="archive">
          <i class="fas fa-archive"></i> Archive
        </button>
      `;
                        }

                        tbody.appendChild(row);
                    });

                    // Привязываем обработчики событий
                    document.querySelectorAll('.btn-view').forEach(button => {
                        button.addEventListener('click', (e) => viewUser(e.target.dataset.id));
                    });

                    document.querySelectorAll('.btn-edit[data-action="toggle-status"]').forEach(button => {
                        button.addEventListener('click', (e) => toggleUserStatus(e.target.dataset.id, e.target.dataset.status));
                    });

                    document.querySelectorAll('.btn-delete[data-action="archive"]').forEach(button => {
                        button.addEventListener('click', (e) => archiveUser(e.target.dataset.id));
                    });

                    document.querySelectorAll('.btn-edit[data-action="restore"]').forEach(button => {
                        button.addEventListener('click', (e) => restoreUser(e.target.dataset.id));
                    });
                }
                // Архивация пользователя
                async function archiveUser(userId) {
                    if (!confirm('Are you sure you want to archive this user?')) {
                        return;
                    }

                    try {
                        const response = await apiRequest(`/v1/admin/users/${userId}/archive`, {
                            method: 'POST'
                        });

                        if (response.success) {
                            showNotification('success', 'User archived successfully');
                            // Перезагружаем список пользователей с учетом текущего раздела
                            const activeSection = document.querySelector('.section.active').id;
                            if (activeSection === 'users') {
                                loadUsers('active');
                            } else if (activeSection === 'users-archive') {
                                loadUsers('archived');
                            }
                        } else {
                            showNotification('error', response.message || 'Error archiving user');
                        }
                    } catch (error) {
                        console.error('Archive error:', error);
                        showNotification('error', 'Error archiving user');
                    }
                }

                // Восстановление пользователя из архива
                async function restoreUser(userId) {
                    if (!confirm('Are you sure you want to restore this user from archive?')) {
                        return;
                    }

                    try {
                        const response = await apiRequest(`/v1/admin/users/${userId}/unarchive`, {
                            method: 'POST'
                        });

                        if (response.success) {
                            showNotification('success', 'User restored successfully');
                            // Перезагружаем список пользователей с учетом текущего раздела
                            const activeSection = document.querySelector('.section.active').id;
                            if (activeSection === 'users') {
                                loadUsers('active');
                            } else if (activeSection === 'users-archive') {
                                loadUsers('archived');
                            }
                        } else {
                            showNotification('error', response.message || 'Error restoring user');
                        }
                    } catch (error) {
                        console.error('Restore error:', error);
                        showNotification('error', 'Error restoring user');
                    }
                }
                async function loadUsers(status = 'active') {
                    const section = document.getElementById('users');
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'loading-indicator';
                    loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading users...';

                    // Удаляем предыдущий индикатор загрузки, если он есть
                    const existingLoader = section.querySelector('.loading-indicator');
                    if (existingLoader) {
                        existingLoader.remove();
                    }

                    // Добавляем новый индикатор загрузки
                    section.appendChild(loadingIndicator);

                    try {
                        const searchInput = section.querySelector('.search-input');
                        const searchParams = new URLSearchParams({
                            page: currentPage,
                            limit: itemsPerPage
                        });

                        // Добавляем параметр статуса только если он не 'all'
                        if (status && status !== 'all') {
                            searchParams.append('status', status);
                        }

                        if (searchInput && searchInput.value) {
                            searchParams.append('search', searchInput.value);
                        }

                        console.log('Loading users with params:', searchParams.toString());
                        const data = await apiRequest(`/v1/admin/users?${searchParams.toString()}`);

                        // Удаляем индикатор загрузки
                        loadingIndicator.remove();

                        // Находим или создаем таблицу
                        let table = section.querySelector('.data-table');
                        if (!table) {
                            // Если таблицы нет, создаем новую структуру
                            const tableContainer = document.createElement('div');
                            tableContainer.className = 'table-container';

                            table = document.createElement('table');
                            table.className = 'data-table';
                            table.innerHTML = `
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>CNIC</th>
            <th>Email</th>
            <th>Properties</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      `;

                            tableContainer.appendChild(table);

                            // Проверяем, есть ли уже пагинация
                            const existingPagination = section.querySelector('.pagination');
                            if (existingPagination) {
                                section.insertBefore(tableContainer, existingPagination);
                            } else {
                                section.appendChild(tableContainer);
                            }
                        }

                        // Рендерим данные
                        if (data && Array.isArray(data)) {
                            // Если сервер возвращает простой массив
                            renderUsersTable(data);

                            // Добавляем или обновляем пагинацию
                            const pagination = createPagination(data.length, currentPage, itemsPerPage);
                            const existingPagination = section.querySelector('.pagination');
                            if (existingPagination) {
                                existingPagination.replaceWith(pagination);
                            } else {
                                section.appendChild(pagination);
                            }
                        } else if (data && Array.isArray(data.users)) {
                            // Если сервер возвращает структурированный ответ с пагинацией
                            renderUsersTable(data.users);

                            // Добавляем или обновляем пагинацию
                            const pagination = createPagination(data.total, currentPage, itemsPerPage);
                            const existingPagination = section.querySelector('.pagination');
                            if (existingPagination) {
                                existingPagination.replaceWith(pagination);
                            } else {
                                section.appendChild(pagination);
                            }
                        } else {
                            console.error('Invalid users data format:', data);
                            const tbody = document.getElementById('usersTableBody');
                            if (tbody) {
                                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found or error loading data</td></tr>';
                            }
                        }

                        // Привязываем обработчики событий к динамическим кнопкам
                        attachActionHandlers();
                    } catch (error) {
                        console.error('Error loading users:', error);

                        // Удаляем индикатор загрузки
                        loadingIndicator.remove();

                        // Показываем сообщение об ошибке
                        let errorContainer = section.querySelector('.error-message');
                        if (!errorContainer) {
                            errorContainer = document.createElement('div');
                            errorContainer.className = 'error-message';
                            errorContainer.style = 'color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 4px; margin: 10px 0;';
                            section.appendChild(errorContainer);
                        }

                        errorContainer.innerHTML = `
      <i class="fas fa-exclamation-circle"></i> Error loading users: ${error.message || 'Unknown error'}
      <button class="retry-btn" style="margin-left: 10px; background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
        Retry
      </button>
    `;

                        // Добавляем обработчик для кнопки повторной попытки
                        const retryBtn = errorContainer.querySelector('.retry-btn');
                        if (retryBtn) {
                            retryBtn.addEventListener('click', () => {
                                errorContainer.remove();
                                loadUsers(status);
                            });
                        }
                    }
                }
                // Добавляем обработчик для поиска
                document.querySelector('#users .search-input')?.addEventListener('input', debounce(function () {
                    currentPage = 1;
                    const activeSection = document.querySelector('.section.active').id;
                    if (activeSection === 'users') {
                        loadUsers('active');
                    } else if (activeSection === 'users-archive') {
                        loadUsers('archived');
                    }
                }, 300));
                function attachActionHandlers3() {
                    document.body.addEventListener('click', function (e) {
                        const button = e.target.closest('.action-btn');
                        if (!button) return;

                        const action = button.getAttribute('data-action');
                        const id = button.getAttribute('data-id');

                        if (!id || !action) return;

                        switch (action) {
                            case 'view':
                                viewTransaction(id);
                                break;
                            case 'view_user':
                                viewUser(id);
                                break;
                            case 'approve':
                                updateTransactionStatus(id, 'approved');
                                break;
                            case 'reject':
                                updateTransactionStatus(id, 'rejected');
                                break;
                            case 'block':
                                toggleUserStatus(id, 'blocked');
                                break;
                            case 'unblock':
                                toggleUserStatus(id, 'active');
                                break;
                        }
                    });
                }
                document.addEventListener('DOMContentLoaded', function () {
                    // Закрытие модалов
                    document.querySelectorAll('.modal-close, .close').forEach(button => {
                        button.addEventListener('click', function () {
                            const modalId = this.getAttribute('data-modal');
                            closeModal(modalId);
                        });
                    });

                    // Закрытие модального окна при клике вне содержимого
                    document.addEventListener('click', function (event) {
                        if (event.target.classList.contains('modal')) {
                            event.target.style.display = 'none';
                        }
                    });

                    // Форма добавления пользователя
                    document.getElementById('addUserForm')?.addEventListener('submit', function (e) {
                        e.preventDefault();
                        createUser(e);
                    });

                    // Регенерация логина и пароля
                    document.querySelector('.regenerate-login-btn')?.addEventListener('click', regenerateLogin);
                    document.querySelector('.regenerate-password-btn')?.addEventListener('click', regeneratePassword);

                    // Форма создания транзакции
                    document.getElementById('createTransactionForm')?.addEventListener('submit', function (e) {
                        e.preventDefault();
                        handleCreateTransaction(e);
                    });

                    // Форма загрузки одного файла
                    document.getElementById('singleFileUploadForm')?.addEventListener('submit', function (e) {
                        e.preventDefault();
                        uploadSingleFile(e);
                    });

                    // Форма множественной загрузки файлов
                    document.getElementById('multipleFileUploadForm')?.addEventListener('submit', function (e) {
                        e.preventDefault();
                        uploadMultipleFiles(e);
                    });
                });
                document.addEventListener('DOMContentLoaded', function () {
                    // Закрытие модальных окон по кнопке "×"
                    document.querySelectorAll('.close').forEach(button => {
                        button.addEventListener('click', function () {
                            const modalId = this.getAttribute('data-modal');
                            closeModal(modalId);
                        });
                    });

                    // Закрытие модального окна при клике вне содержимого
                    document.addEventListener('click', function (event) {
                        if (event.target.classList.contains('modal')) {
                            event.target.style.display = 'none';
                        }
                    });

                    // Редактирование суммы транзакции
                    document.querySelector('.edit-amount-btn')?.addEventListener('click', toggleAmountEdit);

                    // Сохранение новой суммы
                    document.querySelector('.save-amount-btn')?.addEventListener('click', updateTransactionAmount);

                    // Отмена редактирования суммы
                    document.querySelector('.cancel-amount-btn')?.addEventListener('click', cancelAmountEdit);

                    // Сохранение информации о свидетелях
                    document.querySelector('.update-witnesses-btn')?.addEventListener('click', updateWitnesses);
                });
                // Обновление статуса пользователя
                // Обновление статуса пользователя
                async function toggleUserStatus(userId, newStatus) {
                    try {
                        const response = await apiRequest(`/v1/admin/users/${userId}/status`, {
                            method: 'POST',
                            body: JSON.stringify({ status: newStatus })
                        });

                        if (response.success) {
                            showNotification('success', `User status updated to: ${newStatus}`);

                            // Определяем, на какой странице мы сейчас
                            const activeSection = document.querySelector('.section.active').id;
                            if (activeSection === 'users') {
                                loadUsers('active');
                            } else if (activeSection === 'users-archive') {
                                loadUsers('archived');
                            }
                        } else {
                            showNotification('error', response.message || 'Error updating user status');
                        }
                    } catch (error) {
                        console.error('Error updating user status:', error);
                        showNotification('error', 'Error updating user status');
                    }
                }
                // Обновление статуса сделки
                async function updateTransactionStatus(transactionId, status) {
                    try {
                        let notes = null;
                        if (status === 'rejected') {
                            notes = prompt('Please provide a reason for rejection:');
                            if (notes === null) return;
                        }

                        // Исправляем имя поля с admin_notes на reason
                        const response = await apiRequest(`/v1/admin/transactions/${transactionId}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                status,
                                reason: notes
                            })
                        });

                        // Проверяем, что response существует и имеет поле success
                        if (response && response.success) {
                            showNotification('success', `Transaction ${status} successfully`);
                            loadTransactions();
                        } else {
                            const errorMessage = response?.message || 'Error updating transaction';
                            showNotification('error', errorMessage);
                        }
                    } catch (error) {
                        console.error('Error updating transaction status:', error);
                        showNotification('error', 'Failed to update transaction status');
                    }
                }
                // Загрузка документов
                async function uploadDocuments(transactionId) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.multiple = true;
                    input.accept = '.pdf,.doc,.docx,.jpg,.jpeg,.png';

                    input.onchange = async (e) => {
                        const files = Array.from(e.target.files);
                        const formData = new FormData();

                        files.forEach(file => {
                            formData.append('documents[]', file);
                        });

                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}/documents`, {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });

                        if (response.ok) {
                            showNotification('success', 'Documents uploaded successfully');
                            loadTransactions();
                        } else {
                            showNotification('error', 'Failed to upload documents');
                        }
                    };

                    input.click();
                }

                // Очистка истории сделок
                async function clearTransactionHistory() {
                    const date = prompt('Enter date to clear history before (YYYY-MM-DD):');
                    if (!date) return;

                    const response = await apiRequest('/v1/admin/transactions/history/clear', {
                        method: 'POST',
                        body: JSON.stringify({
                            older_than: date,
                            status: ['approved', 'rejected', 'cancelled']
                        })
                    });

                    if (response) {
                        showNotification('success', 'Transaction history cleared successfully');
                        loadTransactions();
                    }
                }

                // Поиск
                function setupSearch() {
                    const searchInputs = document.querySelectorAll('.search-input');
                    searchInputs.forEach(input => {
                        input.addEventListener('input', debounce(function () {
                            currentPage = 1;
                            const section = this.closest('.section').id;
                            if (section === 'users') {
                                loadUsers('active');
                            } else if (section === 'users-archive') {
                                loadUsers('archived');
                            } else if (section === 'transactions') {
                                loadTransactions();
                            }
                        }, 300));
                    });
                }

                // Вспомогательные функции
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func.apply(this, args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // Переключение между разделами
                function showSection(sectionId) {
                    // Скрыть все разделы
                    document.querySelectorAll('.section').forEach(section => {
                        section.style.display = 'none';
                    });

                    // Скрыть все ссылки навигации
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                    });

                    // Показать выбранный раздел
                    const sectionElement = document.getElementById(sectionId);
                    if (!sectionElement) {
                        console.error(`Section with id "${sectionId}" not found in DOM`);

                        // Если раздел не найден, переключаемся на раздел транзакций
                        const transactionsSection = document.getElementById('transactions');
                        if (transactionsSection) {
                            transactionsSection.style.display = 'block';
                            transactionsSection.classList.add('active');

                            // Активируем соответствующую ссылку навигации
                            const navLink = document.querySelector('[href="#transactions"]');
                            if (navLink) {
                                navLink.classList.add('active');
                            }

                            // Загружаем данные для раздела транзакций
                            loadTransactions();

                            return;
                        } else {
                            console.error('Transactions section not found either');
                            return;
                        }
                    }

                    // Элемент найден, показываем его
                    sectionElement.style.display = 'block';
                    sectionElement.classList.add('active');

                    // Активируем соответствующую ссылку навигации
                    const navLink = document.querySelector(`[href="#${sectionId}"]`);
                    if (navLink) {
                        navLink.classList.add('active');
                    }

                    // Загрузить данные для активного раздела
                    if (sectionId === 'users') {
                        console.log('Loading users for active users section');
                        loadUsers('active');
                    } else if (sectionId === 'users-archive') {
                        console.log('Loading archived users');
                        loadUsers('archived');
                    } else if (sectionId === 'transactions') {
                        console.log('Loading transactions for transactions section');
                        loadTransactions();
                    }
                }
                // Переключение категорий объектов
                function toggleCategory(header) {
                    const category = header.parentElement;
                    category.classList.toggle('active');
                }

                // Функции для работы с модальными окнами
                function openModal(modalId) {
                    document.getElementById(modalId).style.display = 'block';
                    loadUsersForSelect();

                }

                function closeModal(modalId) {
                    document.getElementById(modalId).style.display = 'none';
                }

                // Закрытие модального окна при клике вне его содержимого
                document.addEventListener('click', function (event) {
                    if (event.target.classList.contains('modal')) {
                        event.target.classList.remove('show');
                    }
                });

                // Просмотр деталей пользователя
                async function viewUser(userId) {
                    const data = await apiRequest(`/v1/admin/users/${userId}`);
                    if (!data) return;

                    const modalBody = document.getElementById('userModalBody');
                    modalBody.innerHTML = `
                <div class="user-details">
                    <p><strong>ID:</strong> ${data.id}</p>
                    <p><strong>Name:</strong> ${data.name}</p>
                    <p><strong>CNIC:</strong> ${data.cnic}</p>
                    <p><strong>Email:</strong> ${data.email}</p>
                    <p><strong>Status:</strong> <span class="status-badge ${data.status.toLowerCase()}">${data.status}</span></p>
                    <p><strong>Created:</strong> ${new Date(data.created_at).toLocaleString()}</p>
                    
                    <h4>Properties</h4>
                    ${data.properties && data.properties.length > 0 ? `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.properties.map(p => `
                                    <tr>
                                        <td>${p.id}</td>
                                        <td>${p.name}</td>
                                        <td>${p.type}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p>No properties owned</p>'}
                </div>
            `;

                    openModal('userModal');
                }

                // Просмотр деталей сделки
                async function viewTransaction(transactionId) {
                    try {
                        // Устанавливаем ID текущей транзакции
                        document.getElementById('currentTransactionId').value = transactionId;

                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}`, {
                            credentials: 'include'
                        });

                        if (!response.ok)
                            throw new Error('Error load data');

                        const transaction = await response.json();

                        // Заполняем данные в модальном окне
                        document.getElementById('transactionId').textContent = transaction.id;
                        document.getElementById('propertyName').textContent = transaction.property_id;
                        document.getElementById('previousOwner').textContent = transaction.previous_owner_name || 'N/A';
                        document.getElementById('newOwner').textContent = transaction.new_owner_name;
                        document.getElementById('transactionStatus').textContent = transaction.status;
                        document.getElementById('totalAmount').textContent = `${transaction.total_amount} PKR`;
                        document.getElementById('paidAmount').textContent = `${transaction.paid_amount} PKR`;
                        document.getElementById('remainingAmount').textContent = `${transaction.total_amount - transaction.paid_amount} PKR`;
                        document.getElementById('createdAt').textContent = new Date(transaction.created_at).toLocaleString();

                        // Заполняем данные свидетелей из объекта witnesses
                        const { witness1, witness2 } = transaction.witnesses || {};

                        // Заполняем поля для первого свидетеля
                        document.getElementById('witness1Name').value = witness1 ? witness1.name : 'Not assigned';
                        document.getElementById('witness1CNIC').value = witness1 ? witness1.cnic : 'Not assigned';
                        document.getElementById('witness1Phone').value = witness1 ? (witness1.phone || '') : '';

                        // Заполняем поля для второго свидетеля
                        document.getElementById('witness2Name').value = witness2 ? witness2.name : 'Not assigned';
                        document.getElementById('witness2CNIC').value = witness2 ? witness2.cnic : 'Not assigned';
                        document.getElementById('witness2Phone').value = witness2 ? (witness2.phone || '') : '';

                        // Загружаем платежи и файлы
                        await loadTransactionPayments(transactionId),
                            await loadTransactionFiles(transactionId)

                        openModal('viewTransactionModal');
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('error', 'Error load data');
                    }
                }

                // Функция для загрузки платежей
                async function loadTransactionPayments(transactionId) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}/payments`, {
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            showNotification('error', 'Error to fetch')
                            return;
                        }

                        const data = await response.json();

                        const tbody = document.getElementById('paymentsTableBody');

                        tbody.innerHTML = data.payments.map(payment => {
                            console.log('Processing payment:', payment);
                            // Проверяем наличие квитанции
                            const hasReceipt = payment.receipt_file_id && payment.file_path;
                            console.log('Has receipt:', hasReceipt, {
                                receipt_file_id: payment.receipt_file_id,
                                file_path: payment.file_path,
                                original_name: payment.original_name
                            });

                            return `
                        <tr>
                            <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                            <td>${payment.amount} PKR</td>
                            <td><span class="status-badge ${payment.status}">${payment.status}</span></td>
                            <td>
                                ${hasReceipt ? `
                                    <button onclick="downloadFile({
                                        file_name: '${payment.file_path.split('/').pop()}',
                                        original_name: '${payment.original_name}'
                                    })" class="action-btn btn-download">
                                        <i class="fas fa-download"></i> Скачать
                                    </button>
                                ` : 'Нет квитанции'}
                            </td>
                            <td>
                                ${payment.status === 'pending' ? `
                                    <button onclick="updatePaymentStatus(${payment.id}, 'paid')" class="action-btn btn-edit">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button onclick="updatePaymentStatus(${payment.id}, 'cancelled')" class="action-btn btn-delete">
                                        <i class="fas fa-times"></i> Cencel
                                    </button>
                                ` : ''}
                                        </td>
                                    </tr>
                    `;
                        }).join('');
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('error', 'Error when uploading payments');
                    }
                }

                // Функция для создания нового платежа
                async function createPayment(event) {
                    event.preventDefault();

                    const transactionId = document.getElementById('paymentTransactionId').value;
                    if (!transactionId) {
                        showNotification('warning', 'Transaction ID not found');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('amount', document.getElementById('paymentAmount').value);
                    formData.append('payment_date', document.getElementById('paymentDate').value);
                    formData.append('payment_method', document.getElementById('paymentMethod').value);
                    formData.append('notes', document.getElementById('paymentNotes')?.value || '');

                    const receiptFile = document.getElementById('paymentReceipt').files[0];
                    if (receiptFile) {
                        formData.append('receipt', receiptFile);
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}/payments`, {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Error creating payment');
                        }

                        showNotification('success', 'Payment created successfully');
                        document.getElementById('addPaymentForm').reset();
                        closeModal('addPaymentModal');
                        loadTransactionPayments(transactionId);
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('error', error.message || 'Error creating payment');
                    }
                }

                // Функция для загрузки файлов сделки
                async function loadTransactionFiles(transactionId) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}/documents`, {
                            credentials: 'include'
                        });

                        if (!response.ok) throw new Error('Error load fils');

                        const files = await response.json();

                        // Очищаем контейнеры файлов
                        document.getElementById('agreementFile').innerHTML = '';
                        document.getElementById('videoFile').innerHTML = '';

                        // Распределяем файлы по категориям
                        files.forEach(file => {
                            const fileElement = createFileElement(file);
                            switch (file.category) {
                                case 'agreement':
                                    document.getElementById('agreementFile').appendChild(fileElement);
                                    break;
                                case 'video':
                                    document.getElementById('videoFile').appendChild(fileElement);
                                    break;
                                default:
                                    break;
                            }
                        });
                    } catch (error) {
                        console.error('error:', error);
                    }
                }

                // Функция для создания элемента файла
                function createFileElement(file) {
                    const fileContainer = document.createElement('div');
                    fileContainer.className = 'file-item';
                    fileContainer.dataset.fileId = file.id;

                    // Создаем превью файла
                    if (file.file_type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = `${API_BASE_URL}/uploads/${file.file_name}`;
                        img.alt = file.original_name;
                        img.className = 'file-preview';
                        fileContainer.appendChild(img);
                    } else {
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-file-alt file-icon';
                        fileContainer.appendChild(icon);
                    }

                    // Информация о файле
                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'file-info';
                    fileInfo.innerHTML = `
                <p class="file-name">${file.original_name}</p>
                <p class="file-type">${file.file_type}</p>
                <p class="file-date">Загружен: ${new Date(file.created_at).toLocaleString()}</p>
            `;

                    // Кнопки действий
                    const actions = document.createElement('div');
                    actions.className = 'file-actions';

                    // Кнопка просмотра
                    const viewBtn = document.createElement('button');
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i> Просмотр';
                    viewBtn.onclick = () => window.open(`${API_BASE_URL}/uploads/${file.file_name}`, '_blank');
                    actions.appendChild(viewBtn);

                    // Кнопка скачивания
                    const downloadBtn = document.createElement('button');
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> Скачать';
                    downloadBtn.onclick = () => downloadFile(file);
                    actions.appendChild(downloadBtn);

                    // Кнопка удаления
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Удалить';
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.onclick = () => deleteFile(file);
                    actions.appendChild(deleteBtn);

                    fileContainer.appendChild(fileInfo);
                    fileContainer.appendChild(actions);

                    return fileContainer;
                }

                // Функция для скачивания файла
                async function downloadFile(file) {
                    if (!file || !file.file_name) {
                        showNotification('error', 'File not fount');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/uploads/admin/${encodeURIComponent(file.file_name)}?download=true`, {
                            method: 'GET',
                            credentials: 'include'
                        });

                        if (!response.ok) throw new Error('Download failed');

                        // Создаем ссылку для скачивания
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = file.original_name || file.file_name;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        showNotification('success', 'Success');
                    } catch (error) {
                        console.error('Download error:', error);
                        showNotification('error', 'Error load');
                    }
                }

                // Функция для удаления файла
                async function deleteFile(file) {
                    if (!confirm(`Вы уверены, что хотите удалить файл "${file.original_name}"?`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/uploads/${file.file_name}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });

                        if (!response.ok) throw new Error('Delete failed');

                        // Обновляем список файлов
                        const fileElement = document.querySelector(`[data-file-id="${file.id}"]`);
                        if (fileElement) {
                            fileElement.remove();
                        }
                        showNotification('success', 'Deleted');
                    } catch (error) {
                        console.error('Delete error:', error);
                        showNotification('error', 'Error');
                    }
                }

                // Добавляем функцию предпросмотра изображения при выборе файла
                document.getElementById('file')?.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        const previewImage = document.getElementById('previewImage');

                        reader.onload = function (e) {
                            previewImage.src = e.target.result;
                            previewImage.style.display = 'block';
                        }

                        reader.readAsDataURL(file);
                    }
                });

                // Функция для открытия предпросмотра изображения в полном размере
                function openImagePreview(imageSrc) {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                cursor: pointer;
            `;

                    const img = document.createElement('img');
                    img.src = imageSrc;
                    img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;

                    modal.appendChild(img);
                    document.body.appendChild(modal);

                    modal.onclick = () => modal.remove();
                }
                document.getElementById("openAddUserModal").addEventListener("click", function () {
                    openAddUserModal();
                });
                // Функции для работы с новыми пользователями
                function openAddUserModal() {
                    generateLoginCredentials();
                    openModal('addUserModal');
                }

                function generateLoginCredentials() {
                    regenerateLogin();
                    regeneratePassword();
                }

                function regenerateLogin() {
                    const nameInput = document.getElementById('userName');
                    const fullName = nameInput.value || '';

                    let login = '';
                    if (fullName) {
                        const nameParts = fullName.toLowerCase().split(' ').filter(part => part.length > 0);

                        if (nameParts.length > 0) {
                            if (nameParts.length === 1) {
                                login = nameParts[0];
                            }
                            else if (nameParts.length === 2) {
                                login = `${nameParts[0]}_${nameParts[1][0]}`;
                            }
                            else {
                                login = nameParts[0] + '_' + nameParts.slice(1).map(part => part[0]).join('');
                            }
                        }
                    }

                    if (!login) {
                        login = 'user';
                    }

                    const timestamp = Date.now().toString().slice(-4);
                    login = `${login}_${timestamp}`;

                    login = login.toLowerCase()
                        .replace(/[^a-z0-9_]/g, '_')
                        .replace(/_+/g, '_');

                    document.getElementById('userLogin').value = login;
                }

                function regeneratePassword() {
                    const length = 10;
                    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
                    let password = '';
                    for (let i = 0; i < length; i++) {
                        const randomIndex = Math.floor(Math.random() * charset.length);
                        password += charset[randomIndex];
                    }
                    document.getElementById('userPassword').value = password;
                }

                async function createUser(event) {
                    event.preventDefault();

                    const formData = {
                        name: document.getElementById('userName').value,
                        cnic: document.getElementById('userCnic').value,
                        phone: document.getElementById('userPhone').value,
                        address: document.getElementById('userAddress').value,
                        login: document.getElementById('userLogin').value,
                        password: document.getElementById('userPassword').value
                    };

                    const response = await apiRequest('/v1/admin/users', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });

                    if (response) {
                        showNotification('success', 'User created successfully');
                        closeModal('addUserModal');
                        loadUsers('active');
                    }
                }

                // Обновляем генерацию логина при вводе имени
                document.getElementById('userName')?.addEventListener('input', regenerateLogin);

                // Функции для работы со сделками
                async function openCreateTransactionModal() {
                    try {
                        // Очищаем селекты перед загрузкой новых данных
                        document.getElementById('propertyId').innerHTML = '<option value="">Загрузка...</option>';
                        document.getElementById('newOwnerId').innerHTML = '<option value="">Загрузка...</option>';

                        // Открываем модальное окно
                        openModal('createTransactionModal');

                        // Загружаем данные параллельно
                        loadProperties();
                    } catch (error) {
                        console.error('Error opening transaction modal:', error);
                        showNotification('error', 'Error modal');
                    }
                }

                // Загрузка списка пользователей для селектов
                async function loadUsersForSelect() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/users?limit=100`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            },
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            throw new Error('Failed to load users');
                        }

                        const data = await response.json();
                        const newOwnerSelect = document.getElementById('newOwnerId');

                        if (!newOwnerSelect) {
                            console.error('New owner select element not found');
                            return;
                        }

                        // Очищаем селект
                        newOwnerSelect.innerHTML = '<option value="">Select New Owner</option>';

                        // Проверяем наличие пользователей в ответе
                        if (data && data.users && Array.isArray(data.users)) {
                            data.users.forEach(user => {
                                if (user && user.id && user.name) {
                                    const option = document.createElement('option');
                                    option.value = user.id;
                                    option.textContent = `${user.name}${user.cnic ? ` (${user.cnic})` : ''}`;
                                    newOwnerSelect.appendChild(option);
                                }
                            });
                        } else {
                            console.error('Invalid users data structure:', data);
                            throw new Error('Invalid users data received');
                        }
                    } catch (error) {
                        console.error('Error loading users:', error);
                        showNotification('error', "Couldn't load user list:" + error.message);
                    }
                }

                // Добавление элемента графика платежей
                function addPaymentScheduleItem() {
                    const container = document.getElementById('paymentSchedule');
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'payment-schedule-item';
                    itemDiv.innerHTML = `
                <div class="form-group">
                    <input type="number" name="payment_amount" placeholder="Amount" required min="0" step="0.01">
                    <input type="date" name="payment_date" required>
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Remove</button>
                </div>
            `;
                    container.appendChild(itemDiv);
                }

                // Обработка создания транзакции
                async function handleCreateTransaction(event) {
                    event.preventDefault();

                    try {
                        const form = event.target;
                        const formData = {
                            property_id: form.querySelector('[name="property_id"]').value,
                            new_owner_id: parseInt(form.querySelector('[name="new_owner_id"]').value),
                            total_amount: parseFloat(form.querySelector('[name="total_amount"]').value),
                            witnesses: {
                                witness1: {
                                    name: form.querySelector('[name="witness1Name"]').value,
                                    cnic: form.querySelector('[name="witness1CNIC"]').value,
                                    phone: form.querySelector('[name="witness1Phone"]').value
                                },
                                witness2: {
                                    name: form.querySelector('[name="witness2Name"]').value,
                                    cnic: form.querySelector('[name="witness2CNIC"]').value,
                                    phone: form.querySelector('[name="witness2Phone"]').value
                                }
                            }
                        };

                        // Validate data
                        if (!formData.property_id || isNaN(formData.new_owner_id) || isNaN(formData.total_amount)) {
                            showNotification('warning', 'Please fill in all required fields correctly');
                            return;
                        }

                        console.log('Creating transaction with data:', formData);

                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify(formData)
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Error creating transaction');
                        }

                        showNotification('success', 'Transaction created successfully');
                        closeModal('createTransactionModal');
                        loadTransactions();
                    } catch (error) {
                        console.error('Error handling transaction:', error);
                        showNotification('error', error.message || 'Error handling transaction');
                    }
                }

                // Функция для открытия модального окна загрузки одного файла
                function openUploadModal(category) {
                    document.getElementById('uploadCategory').value = category;
                    document.getElementById('uploadTransactionId').value = currentTransactionId;
                    openModal('uploadFileModal');
                }

                // Функция для открытия модального окна множественной загрузки
                function openMultipleUploadModal() {
                    document.getElementById('multiUploadTransactionId').value = currentTransactionId;
                    openModal('multipleUploadModal');
                }

                // Функции для работы с платежами
                function openAddPaymentModal() {
                    const transactionId = document.getElementById('currentTransactionId').value;
                    if (!transactionId) {
                        showNotification('success', 'Transaction ID not found');
                        return;
                    }
                    document.getElementById('paymentTransactionId').value = transactionId;
                    document.getElementById('addPaymentForm').reset();
                    openModal('addPaymentModal');
                }

                // Функция для обновления информации о транзакции
                async function loadTransactionDetails(transactionId) {
                    try {
                        transactionId = document.getElementById('currentTransactionId').value;
                        const response = await fetch(API_BASE_URL + `/v1/admin/transactions/${transactionId}`, {
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            method: 'GET',
                            credentials: 'include',
                        });

                        if (!response.ok) {
                            showNotification('error', "Failed to fetch transaction details")
                            return;
                        }

                        const transaction = await response.json();

                        // Fill main transaction data
                        document.getElementById('transactionId').textContent = transaction.id;
                        document.getElementById('propertyName').textContent = transaction.property_id;
                        document.getElementById('previousOwner').textContent = transaction.previous_owner_name || 'N/A';
                        document.getElementById('newOwner').textContent = transaction.new_owner_name || 'N/A';
                        document.getElementById('transactionStatus').textContent = transaction.status || 'N/A';
                        document.getElementById('createdAt').textContent = new Date(transaction.created_at).toLocaleString();

                        // Fill financial information
                        document.getElementById('totalAmount').textContent = formatAmount(transaction.total_amount) || 'N/A';
                        document.getElementById('paidAmount').textContent = formatAmount(transaction.paid_amount) || 'N/A';
                        document.getElementById('remainingAmount').textContent = formatAmount(transaction.payment_summary.remaining_amount) || 'N/A';

                        // Fill witness data
                        if (transaction.witnesses) {
                            // Witness 1
                            if (transaction.witnesses.witness1) {
                                document.getElementById('witness1Name').value = transaction.witnesses.witness1.name || '';
                                document.getElementById('witness1CNIC').value = transaction.witnesses.witness1.cnic || '';
                                document.getElementById('witness1Phone').value = transaction.witnesses.witness1.phone || '';
                            }

                            // Witness 2
                            if (transaction.witnesses.witness2) {
                                document.getElementById('witness2Name').value = transaction.witnesses.witness2.name || '';
                                document.getElementById('witness2CNIC').value = transaction.witnesses.witness2.cnic || '';
                                document.getElementById('witness2Phone').value = transaction.witnesses.witness2.phone || '';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading transaction details:', error);
                        showNotification('error', 'Failed to load transaction details');
                    }
                }

                async function updatePaymentStatus(paymentId, status) {
                    try {
                        let transactionId = Number(document.getElementById('currentTransactionId').value)
                        const response = await fetch(API_BASE_URL + `/v1/admin/transactions/${paymentId}/payment-status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify({ payment_status: status, transactionId: transactionId })
                        });

                        if (!response.ok) {
                            showNotification('error', "Failed to fetch update")
                            return;
                        }

                        const result = await response.json();

                        if (result.status_updated_to_completed) {
                            showNotification('success', 'Payment marked as paid and transaction status updated to Completed');
                        } else {
                            showNotification('success', 'Payment status updated successfully');
                        }

                        // Reload transaction details
                        loadTransactionDetails(transactionId);

                    } catch (error) {
                        console.error('Error updating payment status:', error);
                        showNotification('error', 'Failed to update payment status');
                    }
                }

                async function uploadSingleFile(event) {
                    event.preventDefault();
                    const form = event.target;
                    const formData = new FormData(form);
                    const transactionId = document.getElementById('currentTransactionId').value;
                    const category = document.getElementById('uploadCategory').value;

                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}/documents`, {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Error uploading file');
                        }

                        const result = await response.json();

                        // Добавляем новый файл в соответствующую категорию
                        const filesContainer = document.getElementById('filesContainer');
                        const categoryDiv = filesContainer.querySelector(`[data-category="${category}"]`) ||
                            createCategoryDiv(category);

                        const filesList = categoryDiv.querySelector('.files-list');
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                    <a href="uploads/${result.files[0].fileName}" target="_blank">
                        ${result.files[0].originalName}
                    </a>
                    <span class="file-date">${new Date().toLocaleString()}</span>
                `;
                        filesList.appendChild(fileItem);

                        showNotification('success', 'File uploaded successfully');
                        closeModal('uploadFileModal');
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('error', error.message || 'Error uploading file');
                    }
                }

                function createCategoryDiv(category) {
                    const filesContainer = document.getElementById('filesContainer');
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'files-category';
                    categoryDiv.setAttribute('data-category', category);
                    categoryDiv.innerHTML = `
                <h4 class="category-title">${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                <div class="files-list"></div>
            `;
                    filesContainer.appendChild(categoryDiv);
                    return categoryDiv;
                }

                async function uploadMultipleFiles(event) {
                    event.preventDefault();

                    const form = event.target;
                    const formData = new FormData(form);
                    const transactionId = document.getElementById('multiUploadTransactionId').value;

                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}/documents`, {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Error uploading files');
                        }

                        const result = await response.json();
                        showNotification('success', 'Files uploaded successfully');
                        closeModal('multipleUploadModal');
                        await loadTransactionFiles(transactionId);
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('error', error.message || 'Error uploading files');
                    }
                }

                // Функция для создания платежа
                async function createPayment(event) {
                    event.preventDefault();

                    const transactionId = document.getElementById('paymentTransactionId').value;
                    if (!transactionId) {
                        showNotification('success', 'Transaction ID not found');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('amount', document.getElementById('paymentAmount').value);
                    formData.append('payment_date', document.getElementById('paymentDate').value);
                    formData.append('payment_method', document.getElementById('paymentMethod').value);
                    formData.append('notes', document.getElementById('paymentNotes')?.value || '');

                    const receiptFile = document.getElementById('paymentReceipt').files[0];
                    if (receiptFile) {
                        formData.append('receipt', receiptFile);
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}/payments`, {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Error creating payment');
                        }

                        showNotification('success', 'Payment created successfully');
                        document.getElementById('addPaymentForm').reset();
                        closeModal('addPaymentModal');
                        loadTransactionPayments(transactionId);
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('error', error.message || 'Error creating payment');
                    }
                }

                // Предпросмотр квитанции
                document.getElementById('receiptFile')?.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('receiptPreview');

                    if (file) {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                preview.innerHTML = `<img src="${e.target.result}" alt="Receipt preview" style="max-width: 200px; margin-top: 10px;">`;
                            };
                            reader.readAsDataURL(file);
                        } else if (file.type === 'application/pdf') {
                            preview.innerHTML = '<i class="fas fa-file-pdf" style="font-size: 48px; color: #dc3545;"></i>';
                        }
                    } else {
                        preview.innerHTML = '';
                    }
                });

                // Функция для загрузки свойств
                async function loadProperties() {
                    try {
                        const propertySelect = document.getElementById('propertyId');
                        if (propertySelect) {
                            propertySelect.innerHTML = '<option value="">Select Property</option>';

                            Object.entries(properties).forEach(([category, items]) => {
                                const group = document.createElement('optgroup');
                                group.label = category.charAt(0).toUpperCase() + category.slice(1);

                                items.forEach(property => {
                                    const option = document.createElement('option');
                                    option.value = property.id;
                                    option.textContent = `${property.name} (${property.type})`;
                                    group.appendChild(option);
                                });

                                propertySelect.appendChild(group);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading properties:', error);
                        showNotification('error', 'Error loading properties');
                    }
                }

                // Функция для создания транзакции
                async function createTransaction(event) {
                    event.preventDefault();

                    const formData = new FormData(event.target);
                    const data = {
                        property_id: formData.get('propertyId'),
                        new_owner_id: parseInt(formData.get('newOwnerId')),
                        total_amount: parseFloat(formData.get('totalAmount')),
                        payment_schedule: []
                    };

                    console.log('Creating transaction:', {
                        url: `${API_BASE_URL}/v1/admin/transactions`,
                        data
                    });

                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify(data)
                        });

                        console.log('Response status:', response.status);
                        const result = await response.json();
                        console.log('Response data:', result);

                        if (!response.ok) {
                            throw new Error(result.message || 'Error creating transaction');
                        }

                        showNotification('success', 'Transaction created successfully');
                        closeModal('createTransactionModal');
                        loadTransactions();
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('error', 'Error creating transaction');
                    }
                }

                // Функция для создания платежа
                async function createPayment(event) {
                    event.preventDefault();

                    const transactionId = document.getElementById('paymentTransactionId').value;
                    if (!transactionId) {
                        showNotification('warning', 'Transaction ID not found');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('amount', document.getElementById('paymentAmount').value);
                    formData.append('payment_date', document.getElementById('paymentDate').value);
                    formData.append('payment_method', document.getElementById('paymentMethod').value);
                    formData.append('notes', document.getElementById('paymentNotes')?.value || '');

                    const receiptFile = document.getElementById('paymentReceipt').files[0];
                    if (receiptFile) {
                        formData.append('receipt', receiptFile);
                    }

                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transactions/${transactionId}/payments`, {
                            method: 'POST',
                            credentials: 'include',
                            body: formData
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'Error creating payment');
                        }

                        showNotification('success', 'Payment created successfully');
                        document.getElementById('addPaymentForm').reset();
                        closeModal('addPaymentModal');
                        loadTransactionPayments(transactionId);
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('error', 'Error creating payment');
                    }
                }
                document.addEventListener('DOMContentLoaded', (event) => {
                    const buttonOpen = document.getElementById('create')
                    buttonOpen.addEventListener('click', (event) => openCreateTransactionModal())
                })
                // Добавляем вызов загрузки свойств при открытии модального окна создания транзакции
                function openCreateTransactionModal() {
                    loadProperties();
                    openModal('createTransactionModal');
                }

                // Добавляем обработку формы
                document.getElementById('newTransactionForm').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    // Собираем данные о свидетелях
                    const witnesses = {
                        witness1: {
                            name: document.getElementById('witness1Name').value,
                            cnic: document.getElementById('witness1CNIC').value,
                            phone: document.getElementById('witness1Phone').value
                        },
                        witness2: {
                            name: document.getElementById('witness2Name').value,
                            cnic: document.getElementById('witness2CNIC').value,
                            phone: document.getElementById('witness2Phone').value
                        }
                    };

                    // Добавляем данные о свидетелях к остальным данным транзакции
                    const formData = {
                        // ... existing transaction data ...
                        witnesses: witnesses
                    };

                    try {
                        const response = await fetch(API_BASE_URL + '/v1/admin/transactions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });

                        if (!response.ok) {
                            throw new Error('Failed to create transaction');
                        }

                        showNotification('success', 'Transaction created successfully');
                        // Очищаем форму или перенаправляем пользователя
                        this.reset();
                    } catch (error) {
                        showNotification('error', 'Error creating transaction: ' + error.message);
                    }
                });

                // Добавляем валидацию CNIC
                function validateCNIC(input) {
                    if (input && input.length == 0) {
                        console.log(input)
                        input.setCustomValidity('Please enter CNIC');
                    }
                }

                // Добавляем валидацию телефона
                function validatePhone(input) {
                    if (input && input.length == 0) {
                        console.log(input)
                        input.setCustomValidity('Please enter phone');
                    }
                }

                // Функция загрузки transfer requests
                async function loadTransferRequestsAdmin() {
                    try {
                        const status = document.getElementById('transferRequestStatus').value;
                        const response = await fetch(`${API_BASE_URL}/v1/admin/transfer-requests${status ? `?status=${status}` : ''}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            },
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            throw new Error('Failed to load transfer requests');
                        }

                        const data = await response.json();
                        const tbody = document.getElementById('transferRequestsTableBody');

                        // Очищаем текущее содержимое
                        tbody.innerHTML = '';

                        // Добавляем строки с данными
                        data.requests.forEach(request => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                <td>${request.id}</td>
                <td>${request.property_id}</td>
                <td>${request.requester_name}</td>
                <td>${request.requester_cnic}</td>
                <td>
                    <span class="status-badge ${request.status.toLowerCase()}">
                        ${request.status}
                    </span>
                </td>
                <td>${new Date(request.created_at).toLocaleDateString()}</td>
                <td>
                    ${request.status === 'pending' ? `
                        <button class="action-btn btn-approve" data-id="${request.id}" data-action="approved">Approve</button>
                        <button class="action-btn btn-reject" data-id="${request.id}" data-action="rejected">Reject</button>
                    ` : ''}
                    <button class="action-btn btn-view" data-id="${request.id}">View Details</button>
                </td>
            `;
                            tbody.appendChild(row);
                        });

                        // Привязываем обработчик событий только один раз
                        attachActionHandlers1();

                    } catch (error) {
                        console.error('Error loading transfer requests:', error);
                        showNotification('error', 'Failed to load transfer requests');
                    }
                }


                // Функция для привязки обработчиков событий
                function attachActionHandlers1() {
                    document.getElementById('transferRequestsTableBody').addEventListener('click', function (e) {
                        const button = e.target.closest('.action-btn');
                        if (!button) return;

                        const action = button.classList.contains('btn-approve') ? 'approved' :
                            button.classList.contains('btn-reject') ? 'rejected' :
                                button.classList.contains('btn-view') ? 'view' : null;

                        const requestId = button.getAttribute('data-id');

                        if (action === 'approved' || action === 'rejected') {
                            handleTransferRequestAction(requestId, action);
                        } else if (action === 'view') {
                            showTransferRequestDetails(requestId);
                        }
                    });
                }
                // Функция загрузки запросов на сделку
                async function loadTransferRequests() {
                    try {
                        const status = document.getElementById('transferRequestStatusFilter').value;

                        const data = await apiRequest(`/v1/admin/transfer-requests${status !== 'all' ? `?status=${status}` : ''}`);

                        const tbody = document.getElementById('transferRequestsTableBody');
                        tbody.innerHTML = '';

                        if (!data || !Array.isArray(data.requests) || data.requests.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="7" class="text-center">No requests found</td></tr>`;
                            return;
                        }

                        data.requests.forEach(request => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                <td>${request.id}</td>
                <td>${request.property_id}</td>
                <td>${request.requester_name}</td>
                <td>${request.requester_cnic}</td>
                <td>
                    <span class="status-badge ${request.status.toLowerCase()}">
                        ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                    </span>
                </td>
                <td>${new Date(request.created_at).toLocaleString()}</td>
                <td class="actions-cell">
                    ${request.status === 'pending' ? `
                        <button class="action-btn btn-approve" data-id="${request.id}" data-action="approved">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="action-btn btn-reject" data-id="${request.id}" data-action="rejected">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    ` : `
                        <span class="action-text">${request.status === 'approved' ? 'Approved' : 'Rejected'}</span>
                        ${request.admin_notes ? `
                            <i class="fas fa-info-circle" title="${request.admin_notes}"></i>
                        ` : ''}
                    `}
                </td>
            `;
                            tbody.appendChild(row);
                        });

                        attachActionHandlers();

                    } catch (error) {
                        console.error('Error loading transfer requests:', error);
                        showNotification('error', 'Failed to load requests');
                    }
                }

                // Функция для привязки обработчиков событий
                function attachActionHandlers() {
                    const tableBody = document.getElementById('transferRequestsTableBody');

                    if (!tableBody) return;

                    tableBody.addEventListener('click', function (e) {
                        const button = e.target.closest('.action-btn');
                        if (!button) return;

                        const action = button.classList.contains('btn-approve') ? 'approved' :
                            button.classList.contains('btn-reject') ? 'rejected' : null;

                        const requestId = button.getAttribute('data-id');

                        if (!action || !requestId) return;

                        handleTransferRequestAction(requestId, action);
                    });
                }

                // Функция обработки действий с запросом
                async function handleTransferRequestAction(requestId, action) {
                    try {
                        let notes = null;
                        if (action === 'rejected') {
                            notes = prompt('Please provide a reason for rejection:');
                            if (notes === null) return; // Пользователь нажал "Отмена"
                        }

                        const response = await apiRequest(`/v1/admin/transfer-requests/${requestId}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                status: action,
                                admin_notes: notes
                            })
                        });

                        if (response.success) {
                            showNotification('success', `Request ${action} successfully`);
                            await loadTransferRequests(); // Перезагружаем список запросов
                        } else {
                            showNotification('error', response.message || 'Error updating request');
                        }
                    } catch (error) {
                        console.error('Error handling transfer request action:', error);
                        showNotification('error', 'Error updating request');
                    }
                }
                // Оберните добавление обработчиков событий в проверку готовности DOM
                document.addEventListener('DOMContentLoaded', function () {
                    // Закрытие модальных окон по кнопке "×"
                    document.querySelectorAll('.modal-close, .close').forEach(button => {
                        button.addEventListener('click', function () {
                            const modalId = this.getAttribute('data-modal');
                            closeModal(modalId);
                        });
                    });

                    // Закрытие модального окна при клике вне его содержимого
                    document.addEventListener('click', function (event) {
                        if (event.target.classList.contains('modal')) {
                            event.target.style.display = 'none';
                        }
                    });

                    // Обработчик для редактирования суммы транзакции
                    document.querySelector('.edit-amount-btn')?.addEventListener('click', toggleAmountEdit);

                    // Обработчик для сохранения новой суммы
                    document.querySelector('.save-amount-btn')?.addEventListener('click', updateTransactionAmount);

                    // Обработчик для отмены редактирования суммы
                    document.querySelector('.cancel-amount-btn')?.addEventListener('click', cancelAmountEdit);

                    // Обработчик для сохранения свидетелей
                    document.querySelector('.update-witnesses-btn')?.addEventListener('click', updateWitnesses);
                });

                // Загружаем запросы при загрузке страницы
                document.addEventListener('DOMContentLoaded', () => {
                    if (document.getElementById('transferRequestsSection')) {
                        loadTransferRequests();
                    }
                });
                // Обработчик действий с запросами
                async function handleTransferRequestAction(requestId, action) {
                    try {
                        let notes = null;
                        if (action === 'rejected') {
                            notes = prompt('Please provide a reason for rejection:');
                            if (notes === null) return; // Пользователь нажал "Отмена"
                        }

                        const response = await apiRequest(`/v1/admin/transfer-requests/${requestId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                status: action,
                                admin_notes: notes
                            })
                        });

                        if (response.success) {
                            showNotification('success', `Request ${action} successfully`);
                            await loadTransferRequests(); // Перезагружаем список запросов
                        } else {
                            showNotification('error', response.message || 'Error updating request');
                        }
                    } catch (error) {
                        console.error('Error handling transfer request action:', error);
                        showNotification('error', 'Error updating request');
                    }
                }

                // Показ деталей запроса
                function showTransferRequestDetails(requestId) {
                    // Здесь можно добавить модальное окно с подробной информацией
                    // о запросе, включая историю изменений и комментарии
                }

                // Добавляем обработчики событий
                document.getElementById('transferRequestStatus')?.addEventListener('change', loadTransferRequestsAdmin);

                // Добавляем загрузку transfer requests при инициализации админ-панели
                document.addEventListener('DOMContentLoaded', function () {
                    if (document.getElementById('transferRequestsSection')) {
                        loadTransferRequestsAdmin();
                    }
                });

                function toggleAmountEdit() {
                    const editSection = document.getElementById('amountEditSection');
                    editSection.style.display = editSection.style.display === 'none' ? 'block' : 'none';
                }

                function updateTransactionAmount() {
                    const newAmount = document.getElementById('newTotalAmount').value;
                    // Здесь реализуйте логику отправки новых данных на сервер
                    console.log('Updating transaction amount to:', newAmount);
                }

                function cancelAmountEdit() {
                    const editSection = document.getElementById('amountEditSection');
                    editSection.style.display = 'none';
                }

                async function updateTransactionAmount() {
                    try {
                        const transactionId = document.getElementById('currentTransactionId').value;
                        const newAmount = document.getElementById('newTotalAmount').value;

                        if (!newAmount || isNaN(newAmount) || newAmount < 0) {
                            showNotification('error', 'Please enter a valid amount');
                            return;
                        }

                        const response = await apiRequest(`/v1/admin/transactions/${transactionId}/update-amount`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                total_amount: parseFloat(newAmount)
                            })
                        });

                        if (response.success) {
                            document.getElementById('totalAmount').textContent = formatCurrency(newAmount);
                            document.getElementById('amountEditSection').style.display = 'none';
                            showNotification('success', 'Amount updated successfully');

                            // Обновляем оставшуюся сумму
                            const paidAmount = parseFloat(document.getElementById('paidAmount').textContent.replace(/[^0-9]/g, '')) || 0;
                            document.getElementById('remainingAmount').textContent = formatCurrency(newAmount - paidAmount);
                        } else {
                            showNotification('error', response.message || 'Failed to update amount');
                        }
                    } catch (error) {
                        console.error('Error updating transaction amount:', error);
                        showNotification('error', 'Failed to update amount');
                    }
                }

                function formatCurrency(amount) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'PKR'
                    }).format(amount);
                }

                async function loadWitnesses(transactionId) {
                    try {
                        const response = await apiRequest(`/v1/admin/transactions/${transactionId}/witnesses`);

                        if (response.success && response.witnesses) {
                            const { witness1, witness2 } = response.witnesses;

                            if (witness1) {
                                document.getElementById('witness1Name').value = witness1.name || '';
                                document.getElementById('witness1CNIC').value = witness1.cnic || '';
                                document.getElementById('witness1Phone').value = witness1.phone || '';
                            }

                            if (witness2) {
                                document.getElementById('witness2Name').value = witness2.name || '';
                                document.getElementById('witness2CNIC').value = witness2.cnic || '';
                                document.getElementById('witness2Phone').value = witness2.phone || '';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading witnesses:', error);
                        showNotification('error', 'Failed to load witnesses information');
                    }
                }

                async function updateWitnesses() {
                    try {
                        const transactionId = document.getElementById('currentTransactionId').value;

                        const witnessesData = {
                            witness1: {
                                name: document.getElementById('witness1Name').value.trim(),
                                cnic: document.getElementById('witness1CNIC').value.trim(),
                                phone: document.getElementById('witness1Phone').value.trim()
                            },
                            witness2: {
                                name: document.getElementById('witness2Name').value.trim(),
                                cnic: document.getElementById('witness2CNIC').value.trim(),
                                phone: document.getElementById('witness2Phone').value.trim()
                            }
                        };

                        // Валидация
                        for (const witness of [witnessesData.witness1, witnessesData.witness2]) {
                            if (!witness.name) {
                                showNotification('error', 'Witness name is required');
                                return;
                            }
                            /** if (!validateCNIC(witness.cnic)) {
                                 showNotification('error', 'Invalid CNIC format (XXXXX-XXXXXXX-X)');
                                 return;
                             }
                             if (witness.phone && !validatePhone(witness.phone)) {
                                 showNotification('error', 'Invalid phone format (+XXXXXXXXXXXX)');
                                 return;
                             }**/
                        }

                        const response = await apiRequest(`/v1/admin/transactions/${transactionId}/witnesses`, {
                            method: 'PUT',
                            body: JSON.stringify(witnessesData)
                        });

                        if (response.success) {
                            showNotification('success', 'Witnesses information updated successfully');
                        } else {
                            showNotification('error', response.message || 'Failed to update witnesses');
                        }
                    } catch (error) {
                        console.error('Error updating witnesses:', error);
                        showNotification('error', 'Failed to update witnesses');
                    }
                }

                function formatAmount(amount) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(amount);
                }

                function getStatusBadgeClass(status) {
                    const statusClasses = {
                        'pending': 'warning',
                        'approved': 'success',
                        'rejected': 'danger',
                        'cancelled': 'secondary',
                        'paid': 'success',
                        'not_started': 'secondary',
                        'in_progress': 'primary',
                        'completed': 'success'
                    };
                    return statusClasses[status] || 'secondary';
                }
            </script>
</body>

</html>